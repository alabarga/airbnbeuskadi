---
title: "Airbnb en Donostia y Euskadi"
author: "montera34"
date: "March 25, 2017"
output: html_document
---

```{r setup, include=FALSE, cache = TRUE}

library("tidyverse")
#carga librería para reagrupar tablas de datos y hacer "melt"
library("reshape2") #no sé la diferencia con "reshape"

#importa datos
listings = read.csv("data/listings_euskadi.csv")

#otras ciudades
#listings_madrid = read.csv("data/listings_madrid.csv")
listings_barcelona = read.csv("data/listings_barcelona.csv")
#listings_mallorca = read.csv("data/listings_mallorca.csv")

#view data basics
str(listings)
head(listings)
#añade variables para acceso fácil
attach(listings)
summary(listings)

#creates variable True/false license
listings$withlicense <- listings$license!=""
#listings[,c(88,96)]

#municipios
citieslevels = levels(city)
cities = data.frame(citieslevels) #eran 330 y tras limpieza  270
ncities = nrow(cities) #número de municipios diferentes

propertytype = data.frame(levels(property_type))
roomtype = data.frame(levels(room_type))

#listados por capitales
donostia = listings[city=="Donostia",] #eran 799 y tras limpieza  1215
bilbao = listings[city=="Bilbao",]
vitoria = listings[city=="Vitoria-Gasteiz",]

#número de pisos en las capitales
ntotal = nrow(listings) #numero de pisos
ndonostia = nrow(donostia)
nbilbao = nrow(bilbao)
nvitoria = nrow(vitoria)

#nmadrid = nrow(listings_madrid)
nbarcelona = nrow(listings_barcelona)
#nmallorca = nrow(listings_mallorca)

#pisos con licencia
ntotallicencia = nrow(listings[license!= "",])
ndonostialicencia = nrow(listings[license!= ""&city=="Donostia",])
nbilbaolicencia = nrow(listings[license!= ""&city=="Bilbao",])
nvitorialicencia = nrow(listings[license!= ""&city=="Vitoria-Gasteiz",])
#ndonostialicencia = nrow(donostia[donostia$license!= "",]) # dan mismo resultado

#donostialicencia = listings[license!= ""&city=="Donostia",]

#nmadridlicencia = nrow(listings_madrid[listings_madrid$license!= "",88])
nbarcelonalicencia = nrow(listings_barcelona[listings_barcelona$license!= "",])
#nmallorcalicencia = nrow(listings_mallorca[listings_mallorca$license!= "",])

# % pisos con licencia
totalLicenciaPerCent = ntotallicencia / ntotal
donostiaLicenciaPerCent = ndonostialicencia / ndonostia
bilbaoLicenciaPerCent = nbilbaolicencia / nbilbao
vitoriaLicenciaPerCent = nvitorialicencia / nvitoria

#madridLicenciaPerCent = nmadridlicencia / nmadrid
barcelonaLicenciaPerCent = nbarcelonalicencia / nbarcelona
#mallorcaLicenciaPerCent = nmallorcalicencia / nmallorca
```

#Qué datos tenemos
La base de datos para Euskadi de Inside Airbnb contiene `r ntotal` alojamientos en `r ncities` municipios, de ellos `r ntotallicencia ` tienen licencia de alojamiento turístico (`r format(round(100*totalLicenciaPerCent, 1), nsmall = 1)`%). 

Por comparar, en otras ciudades, el porcentaje de alojamientos con licencia es Barcelona (`r format(round(100*barcelonaLicenciaPerCent, 1), nsmall = 1)` de un total de `r nbarcelona`,%), Madrid  (0%) y Mallorca (0%)

De ellos:

 + Donostia - San Sebastián `r ndonostia` (`r format(round(100*ndonostia/ntotal, 1), nsmall = 1) ` % del total), de ellos con licencia `r ndonostialicencia` (`r format(round(100*donostiaLicenciaPerCent, 1), nsmall = 1)` % del municipio).
 + Bilbao `r nbilbao` (`r format(round(100*nbilbao/ntotal, 1), nsmall = 1) `% del total), de ellos con licencia `r nbilbaolicencia` (`r format(round(100*bilbaoLicenciaPerCent, 1), nsmall = 1)` % del municipio).
 + Vitoria-Gasteiz `r nvitoria` (`r format(round(100*nvitoria/ntotal, 1), nsmall = 1) `% del total), de ellos con licencia `r nvitorialicencia` (`r format(round(100*vitoriaLicenciaPerCent, 1), nsmall = 1)` % del municipio).



## Número de dormitorios y tipo de alojamiento
```{r, echo = FALSE, warning=FALSE}
ggplot(data = listings) + 
  geom_point(mapping = aes(x = property_type, y = bedrooms, color = availability_365),  position = "jitter") + coord_flip()
```

## Número de dormitorios y tipo de oferta
```{r, echo = FALSE, warning=FALSE}
ggplot(data = listings) + 
  geom_point(mapping = aes(x = room_type, y = minimum_nights, color = availability_365 ),  position = "jitter")  + coord_flip()
```

## Número de dormitorios y tipo de oferta en Donosti
```{r, echo = FALSE, warning=FALSE}
ggplot(data = donostia) + 
  geom_point(mapping = aes(x = room_type, y = bedrooms, color = minimum_nights ),  position = "jitter")  + coord_flip()
```



```{r, echo = FALSE, warning=FALSE}
ggplot(donostia) +   geom_bar(mapping = aes(x = bedrooms)) + labs(title= "Donostia" )
ggplot(donostialicencia) +   geom_bar(mapping = aes(x = bedrooms)) + labs(title= "Donostia con licencia" ) #cambiar por variable withlicense

ggplot(donostia) +   geom_bar(mapping = aes(x = host_name)) #necesita reordenar

ggplot(donostia) + geom_bar(mapping = aes(x = host_listings_count))
ggplot(donostia) + geom_bar(mapping = aes(x = host_total_listings_count))

ggplot(donostia) + geom_bar(mapping = aes(x = property_type)) + coord_flip() + labs(title= "Donostia" )
ggplot(donostialicencia) + geom_bar(mapping = aes(x = property_type)) + coord_flip() + labs(title= "Donostia con licencia" ) #cambiar por variable withlicense

ggplot(data = donostia) + 
  stat_summary(
    mapping = aes(x = property_type, y = bedrooms),
    fun.ymin = min,
    fun.ymax = max,
    fun.y = median
  )

ggplot(donostia) + geom_bar(mapping = aes(x = room_type)) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = accommodates )) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = bed_type )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = number_of_reviews )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = review_scores_value )) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = instant_bookable )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = require_guest_profile_picture )) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = require_guest_phone_verification )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = calculated_host_listings_count )) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = reviews_per_month )) + coord_flip()

#scatter plots

ggplot(donostia) + geom_point(mapping = aes(x = beds, y = reviews_per_month), position = "jitter")
ggplot(donostia) + geom_point(mapping = aes(x = cancellation_policy, y = reviews_per_month, shape = property_type, color = property_type), position = "jitter")
ggplot(donostia) + geom_point(mapping = aes(x = beds, y = calculated_host_listings_count, shape = property_type, color = withlicense), position = "jitter")

ggplot(listings) + 
  geom_point(mapping = aes(x = property_type, y = review_scores_rating)) + 
  facet_wrap(~ withlicense, ncol= 2) + coord_flip()

ggplot(listings) + 
  stat_summary(
    mapping = aes(x = property_type, y = number_of_reviews),
    fun.ymin = min,
    fun.ymax = max,
    fun.y = median
  ) + coord_flip() +
  facet_wrap(~ withlicense, nrow = 2)
```

