---
title: "Airbnb en Donostia y Euskadi"
author: "montera34"
date: "March 30, 2017"
output: html_document
---

```{r setup, include=FALSE, cache = TRUE}

require("tidyverse")
#carga librería para reagrupar tablas de datos y hacer "melt"
library("reshape2") #no sé la diferencia con "reshape"

#importa datos
listings = read.csv("data/listings_euskadi.csv")

#otras ciudades
#listings_madrid = read.csv("data/listings_madrid.csv")
listings_barcelona = read.csv("data/listings_barcelona.csv")
#listings_mallorca = read.csv("data/listings_mallorca.csv")

#view data basics
str(listings)
head(listings)
#añade variables para acceso fácil
attach(listings)
summary(listings)

#creates variable True/false license
listings$withlicense <- listings$license!=""
#listings[,c(88,96)]

#municipios
citieslevels = levels(city)
cities = data.frame(citieslevels) #eran 330 y tras limpieza  270
ncities = nrow(cities) #número de municipios diferentes

propertytype = data.frame(levels(property_type))
roomtype = data.frame(levels(room_type))

#listados por capitales
donostia = listings[city=="Donostia",] #eran 799 y tras limpieza  1215
bilbao = listings[city=="Bilbao",]
vitoria = listings[city=="Vitoria-Gasteiz",]

#número de pisos en las capitales
ntotal = nrow(listings) #numero de pisos
ndonostia = nrow(donostia)
nbilbao = nrow(bilbao)
nvitoria = nrow(vitoria)

#nmadrid = nrow(listings_madrid)
nbarcelona = nrow(listings_barcelona)
#nmallorca = nrow(listings_mallorca)

#pisos con licencia
ntotallicencia = nrow(listings[license!= "",])
ndonostialicencia = nrow(listings[license!= ""&city=="Donostia",])
nbilbaolicencia = nrow(listings[license!= ""&city=="Bilbao",])
nvitorialicencia = nrow(listings[license!= ""&city=="Vitoria-Gasteiz",])
#ndonostialicencia = nrow(donostia[donostia$license!= "",]) # dan mismo resultado

#donostialicencia = listings[license!= ""&city=="Donostia",]

#nmadridlicencia = nrow(listings_madrid[listings_madrid$license!= "",88])
nbarcelonalicencia = nrow(listings_barcelona[listings_barcelona$license!= "",])
#nmallorcalicencia = nrow(listings _mallorca[listings_mallorca$license!= "",])

# % pisos con licencia
totalLicenciaPerCent = ntotallicencia / ntotal
donostiaLicenciaPerCent = ndonostialicencia / ndonostia
bilbaoLicenciaPerCent = nbilbaolicencia / nbilbao
vitoriaLicenciaPerCent = nvitorialicencia / nvitoria

#madridLicenciaPerCent = nmadridlicencia / nmadrid
barcelonaLicenciaPerCent = nbarcelonalicencia / nbarcelona
#mallorcaLicenciaPerCent = nmallorcalicencia / nmallorca

#--------------------------export data --------------------
#exports only some columns to avoid problems with scapes in data
donostia_simple = donostia[,c(1,5,20,22,23,49,50,51,52,53,54,55,56,57,58,61,75,77,88,96)]

#exporta data
write.table(donostia, "data/donostia.tsv", sep="\t",row.names=FALSE)
#need to export to tsv to avoid prolems with comas inside data
write.table(donostia_simple, "data/donostia_simple.tsv", sep="\t",row.names=FALSE) 
```

#Qué datos tenemos
La base de datos de Euskadi de InsideAirbnb contiene `r ntotal` alojamientos en `r ncities` municipios, de ellos `r ntotallicencia ` tienen licencia de alojamiento turístico (`r format(round(100*totalLicenciaPerCent, 1), nsmall = 1)`%). 

En las capitales tenemos:

 + *Donostia - San Sebastián* `r ndonostia` (`r format(round(100*ndonostia/ntotal, 1), nsmall = 1) ` % del total), de esos alojamientos tienen licencia `r ndonostialicencia` (`r format(round(100*donostiaLicenciaPerCent, 1), nsmall = 1)` % del municipio). Dispone de `r sum(donostia$accommodates) ` plazas.
 + Bilbao `r nbilbao` (`r format(round(100*nbilbao/ntotal, 1), nsmall = 1) `% del total), de esos alojamientos tienen licencia `r nbilbaolicencia` (`r format(round(100*bilbaoLicenciaPerCent, 1), nsmall = 1)` % del municipio). Dispone de `r sum(bilbao$accommodates) ` plazas.
 + Vitoria-Gasteiz `r nvitoria` (`r format(round(100*nvitoria/ntotal, 1), nsmall = 1) `% del total), de esos alojamientos tienen licencia `r nvitorialicencia` (`r format(round(100*vitoriaLicenciaPerCent, 1), nsmall = 1)` % del municipio). Dispone de `r sum(vitoria$accommodates) ` plazas.

En Donostia existen `r length(levels(as.factor(donostia$host_id)))` usuarios con alojamientos disponibles en Airbnb. 


Por comparar, en otras ciudades, el porcentaje de alojamientos con licencia es Barcelona (`r format(round(100*barcelonaLicenciaPerCent, 1), nsmall = 1)`% de un total de `r nbarcelona` alojamientos), Madrid (0%) y Mallorca (0%), según datos de insideairbnb.


#Datos para Donostia - San Sebastián
```{r, echo = FALSE, warning=FALSE}
#ggplot(donostia) + geom_bar(mapping = aes(x = beds)) + labs(title= "Donostia" )
#ggplot(donostia[donostia$withlicense==TRUE,]) + geom_bar(mapping = aes(x = beds)) + labs(title= "Donostia con licencia")

ggplot(donostia) + geom_bar(mapping = aes(x = beds)) + labs(title= "Número alojamientos según su nº de camas con y sin licencia" ) + scale_x_continuous(breaks=seq(0,12,1)) + facet_wrap(~ withlicense, ncol= 2) + coord_flip()

ggplot(donostia) +  geom_bar(mapping = aes(x = beds, fill = withlicense)) + labs(title= "Número alojamientos según su nº de plazas (camas) con y sin licencia" ) + scale_x_continuous(breaks=seq(0,12,1)) + coord_flip()

ggplot(donostia) +  geom_bar(mapping = aes(x = property_type, fill = withlicense)) + labs(title= "Nº alojamientos según tipo de alojamiento y con/sin licencia" ) + coord_flip()
```

## Usuarios de Airbnb
```{r, echo = FALSE, warning=FALSE}
# To change plot order of bars, change levels in underlying factor
reorder_size <- function(x) {
  factor(x, levels = names(sort(table(x))))
}

#ggplot(donostia) +geom_bar(mapping = aes(reorder_size(host_name), fill = withlicense)) + coord_flip() host_name da error porque hay usuarios que comparten nombre
ggplot(donostia) +geom_bar(mapping = aes(reorder_size(host_id), fill = withlicense)) + coord_flip()

#ggplot(donostia) +geom_bar(mapping = aes(x = host_name, fill = withlicense)) #necesita reordenar

propietarios <- table(donostia$host_id) #crea tabla con frecuencias (count)
propietarios <- propietarios[order(-propietarios)] #reordena de mayor a menor
write.csv(propietarios, "data/propietarios_id_n_alojamientos_donostia.csv") #exporta datos a csv
propietarios_nalojamientos <- data.frame(propietarios)

```

## Los usuarios con más alojamientos
```{r table_propietarios, echo = FALSE}
library(knitr,quietly=T)
kable(t(as.matrix(propietarios_nalojamientos[1:20,])),caption = "Los 20 usuarios con más alojamientos (id)")
```



## Los usuarios con más plazas


```{r table_propietarios_2, echo = FALSE}
require(dplyr) #no sé si necesario
library(dplyr) #no sé si necesario
#install.packages(dplyr)
naccommodates <- donostia %>%
  group_by(host_id) %>%
  summarize(sum.accomodates=sum(accommodates)) %>%
  #mutate(plazas=sum(accommodates)) %>%
arrange(desc(sum.accomodates))

kable(naccommodates[1:20,],caption = "Los 20 usuarios con más plazas (id)")
```

Los **10** primeros usuarios (`r format(round(100*10/length(levels(as.factor(donostia$host_id))), 1), nsmall = 1)`% del total de usuarios) con más plazas tienen `r sum(naccommodates[1:10,2])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:10,2])/sum(donostia$accommodates), 1), nsmall = 1) `% del total de plazas).

Los **20** primeros usuarios (`r format(round(100*20/length(levels(as.factor(donostia$host_id))), 1), nsmall = 1)`% del total de usuarios) con más plazas tienen `r sum(naccommodates[1:20,2])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:20,2])/sum(donostia$accommodates), 1), nsmall = 1) `% del total de plazas).

Los **50** primeros usuarios (`r format(round(100*50/length(levels(as.factor(donostia$host_id))), 1), nsmall = 1)`% del total de usuarios) con más plazas tienen `r sum(naccommodates[1:50,2])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:50,2])/sum(donostia$accommodates), 1), nsmall = 1) `% del total de plazas).

Los **100** primeros usuarios (`r format(round(100*100/length(levels(as.factor(donostia$host_id))), 1), nsmall = 1)`% del total de usuarios) con más plazas tienen `r sum(naccommodates[1:100,2])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:100,2])/sum(donostia$accommodates), 1), nsmall = 1) `% del total de plazas).

## Otros
```{r, echo = FALSE, warning=FALSE}
ggplot(donostia) + geom_bar(mapping = aes(reorder_size(host_listings_count), fill = withlicense))
ggplot(donostia) + geom_bar(mapping = aes(x = host_total_listings_count))

ggplot(data = donostia) + 
  stat_summary(
    mapping = aes(x = property_type, y = bedrooms),
    fun.ymin = min,
    fun.ymax = max,
    fun.y = median
  ) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = room_type, fill = withlicense)) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = accommodates, fill = withlicense)) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = bed_type, fill = withlicense )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = number_of_reviews, fill = withlicense )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = review_scores_value, fill = withlicense )) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = instant_bookable, fill = withlicense )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = require_guest_profile_picture )) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = require_guest_phone_verification )) + coord_flip()

ggplot(donostia) + geom_bar(mapping = aes(x = calculated_host_listings_count )) + coord_flip()
ggplot(donostia) + geom_bar(mapping = aes(x = reviews_per_month )) + coord_flip()

#scatter plots
ggplot(donostia) + geom_point(mapping = aes(x = beds, y = reviews_per_month), position = "jitter")
ggplot(donostia) + geom_point(mapping = aes(x = cancellation_policy, y = reviews_per_month, shape = property_type, color = property_type), position = "jitter")
ggplot(donostia) + geom_point(mapping = aes(x = beds, y = calculated_host_listings_count, shape = property_type, color = withlicense), position = "jitter")
ggplot(listings) + geom_point(mapping = aes(x = beds, y = number_of_reviews, shape = property_type, color = withlicense), position = "jitter")

ggplot(listings) + 
  geom_point(mapping = aes(x = property_type, y = number_of_reviews)) + 
  facet_wrap(~ withlicense, ncol= 2) + coord_flip()

ggplot(listings) + 
  stat_summary(
    mapping = aes(x = property_type, y = number_of_reviews),
    fun.ymin = min,
    fun.ymax = max,
    fun.y = median
  ) + coord_flip() +
  facet_wrap(~ withlicense, nrow = 2)
```


## Número de dormitorios y tipo de alojamiento (Euskadi)
```{r, echo = FALSE, warning=FALSE}
ggplot(data = listings) + 
  geom_point(mapping = aes(x = property_type, y = bedrooms, color = withlicense),  position = "jitter") + coord_flip()
```

## Número de dormitorios y tipo de oferta (Euskadi)
```{r, echo = FALSE, warning=FALSE}
ggplot(data = listings) + 
  geom_point(mapping = aes(x = room_type, y = minimum_nights, color = withlicense),  position = "jitter")  + coord_flip()
```

## Número de dormitorios y tipo de oferta en Donosti
```{r, echo = FALSE, warning=FALSE}
ggplot(data = donostia) + 
  geom_point(mapping = aes(x = room_type, y = bedrooms, color = withlicense),  position = "jitter")  + coord_flip()
```

